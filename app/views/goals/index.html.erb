<div class="container">
  <h1 class="text-center mt-4 mb-4">My Goals</h1>

  <div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-6">
      <%= form_tag(goals_path, method: :get, class: "simple_form search") do %>
        <div class="search-form-control form-group">
          <div class="input-group">
            <%= text_field_tag(:query, params[:query], class: "form-control", placeholder: 'Search goals...') %>
            <button class="btn btn-flat rounded-end" type="submit">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>


  <% if @goals.empty? %>
    <h5>You haven't setted any goal!</h5>
    <%= link_to "Set your first goal here", new_goal_path, class: "btn btn-success" %>
  <% else %>
    <% favorite_array = [] %>
    <% @goals.each do |goal| %>
      <% if goal.favorite == true %>
        <% favorite_array << goal %>
      <% end %>
    <% end %>

    <% if favorite_array.empty? %>
      <h3 class="text-center"><%= @goals.first.name %></h3>

      <div class="row justify-content-center">
        <div class="col-8 col-sm-6">
          <img src="https://m.media-amazon.com/images/I/716+A9OrcSL._AC_SL1500_.jpg" alt="" class="img-fluid mx-auto d-block">
        </div>
      </div>

      <% current_user.balance = (current_user.incomes.sum(:amount) - current_user.expenses.sum(:amount)) %>
      <% percentage = ((current_user.balance * 100) / @goals.first.amount).round() %>
      <% if percentage > 100 %>
        <% percentage = 100 %>
      <% end %>

      <div class="shadow">
        <div class="progress mt-4 mb-2" style="height: 30px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: <%= percentage %>%;" aria-valuenow="<%= percentage %>" aria-valuemin="0" aria-valuemax="100"><%= percentage %>%</div>
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <p>Saved Amount: $<%= current_user.balance %></p>
        <p><%= @goals.first.name %>'s Price: $<%= @goals.first.amount %></p>
      </div>

      <div class="d-flex justify-content-end mt-3 mb-3">
        <%= link_to "Add Goal", new_goal_path, class: "btn btn-success" %>
      </div>

      <% @goals.each do |goal| %>
        <div class="card-product mb-3 rounded" style="">
          <% if goal.photo.attached? %>
            <td> <%= cl_image_tag goal.photo.key, style: "width: 150px; max-height: 100px;" %></td>
          <% else %>
            <td><img src="https://m.media-amazon.com/images/I/716+A9OrcSL._AC_SL1500_.jpg" alt="" style="width: 150px; max-height: 100px;"></td>
          <% end %>
          <div class="card-product-infos text-center">
            <div class="d-flex">
            <h2 class="ms-3"><%= goal.name %></h2>
            <h2 style="margin-left: 200px;">$<%= goal.amount %> <i class="fa-solid fa-circle-info" data-controller="tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= goal.created_at.strftime('%A, %d %b %Y %l:%M %p') %>"></i></h2>
            <%= link_to favorite_goal_path(goal), data: { turbo_method: :patch } do %>
              <% if goal.favorite == false %>
                <i class="fa-regular fa-star fs-4 ms-5 me-5 text-dark"></i>
              <% else %>
                <i class="fa-solid fa-star fs-4 ms-5 me-5 text-success"></i>
              <% end %>
            <% end %>
            <%= link_to edit_goal_path(goal), class: "btn btn-success me-3", style: "width: 35px; padding: 10px" do %>
              <%= content_tag(:i, "", class: "fa-solid fa-pencil-alt") %>
            <% end %>
            <%= link_to goal_path(goal), method: :delete,
                data: { turbo_method: 'DELETE', turbo_confirm: "Delete #{goal.name} Expense?" },
                class: "btn btn-danger", style: "width: 35px; padding: 10px" do %>
                  <%= content_tag(:i, "", class: "fa-solid fa-trash-can") %>
            <% end %>
          </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <h3 class="text-center"><%= favorite_array.first.name %></h3>

      <div class="row justify-content-center">
        <div class="col-8 col-sm-6">
          <% if favorite_array.first.photo.attached? %>
            <%= cl_image_tag favorite_array.first.photo.key, class:"img-fluid mx-auto d-block rounded-4"%>
          <% else %>
            <img src="https://m.media-amazon.com/images/I/716+A9OrcSL._AC_SL1500_.jpg" alt="" style="width: 150px; max-height: 100px;">
          <% end %>
        </div>
      </div>

      <% current_user.balance = (current_user.incomes.sum(:amount) - current_user.expenses.sum(:amount)) %>
      <% percentage = ((current_user.balance * 100) / favorite_array.first.amount).round() %>
      <% if percentage > 100 %>
        <% percentage = 100 %>
      <% end %>

      <div class="shadow">
        <div class="progress mt-4 mb-2" style="height: 30px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: <%= percentage %>%;" aria-valuenow="<%= percentage %>" aria-valuemin="0" aria-valuemax="100"><%= percentage %>%</div>
        </div>
      </div>
      <div class="d-flex justify-content-between">
        <p>Saved Amount: $<%= current_user.balance %></p>
        <p><%= favorite_array.first.name %>'s Price: $<%= favorite_array.first.amount %></p>
      </div>

      <div class="d-flex justify-content-end mt-3 mb-3">
        <%= link_to "Add Goal", new_goal_path, class: "btn btn-success" %>
      </div>

      <% @goals.each do |goal| %>
        <div class="card-product mb-3 rounded" style="">
          <% if goal.photo.attached? %>
            <td> <%= cl_image_tag goal.photo.key, style: "width: 150px; max-height: 100px;" %></td>
          <% else %>
            <td><img src="https://m.media-amazon.com/images/I/716+A9OrcSL._AC_SL1500_.jpg" alt="" style="width: 150px; max-height: 100px;"></td>
          <% end %>
          <div class="card-product-infos">
            <div class="d-flex">
            <h2 class="ms-3"><%= goal.name %></h2>
            <h2 style="margin-left: 200px;">$<%= goal.amount %>  <i class="fa-solid fa-circle-info" data-controller="tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= goal.created_at.strftime('%A, %d %b %Y %l:%M %p') %>"></i></h2>
            <%= link_to favorite_goal_path(goal), data: { turbo_method: :patch } do %>
              <% if goal.favorite == false %>
                <i class="fa-regular fa-star fs-4 ms-5 me-5 text-dark"></i>
              <% else %>
                <i class="fa-solid fa-star fs-4 ms-5 me-5 text-success"></i>
              <% end %>
            <% end %>
            <%= link_to edit_goal_path(goal), class: "btn btn-success me-3", style: "width: 35px; padding: 10px" do %>
              <%= content_tag(:i, "", class: "fa-solid fa-pencil-alt") %>
            <% end %>
            <%= link_to goal_path(goal), method: :delete,
                data: { turbo_method: 'DELETE', turbo_confirm: "Delete #{goal.name} Expense?" },
                class: "btn btn-danger", style: "width: 35px; padding: 10px" do %>
                  <%= content_tag(:i, "", class: "fa-solid fa-trash-can") %>
            <% end %>
          </div>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
